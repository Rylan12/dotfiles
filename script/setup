#!/bin/bash
set -eu

RED='\033[0;31m'
GREEN='\033[0;32m'
ORANGE='\033[0;33m'
CYAN='\033[0;36m'
NC='\033[0m'

# Detect the dotfiles directory based on this script's location
DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# Link files from files/* into the home directory
# If a file exists and is not the correct symlink, back it up as <file>.bk
find "$DOTFILES_DIR/files" -mindepth 1 -maxdepth 1 -print0 | while IFS= read -r -d '' f; do
  name="$(basename "$f")"
  target="$HOME/$name"

  # Skip .DS_Store files
  [[ "$name" = ".DS_Store" ]] && continue

  if [[ -e "$target" ]]; then
    if [[ "$(readlink -- "$target")" != "$f" ]]; then
    mv "$target" "$target.bk"
      printf " ${RED}Warning${NC}  Overwriting ${CYAN}%s${NC}\n" "$target"
    else
      printf "${ORANGE}Skipping${NC}  %s\n" "$name"
      continue
    fi
  fi

  printf " ${GREEN}Linking${NC}  %s\n" "$name"
  ln -sfn "$f" "$target"
done

# Run the remaining setup scripts
"$DOTFILES_DIR/script/setup-shell"
"$DOTFILES_DIR/script/setup-git"
"$DOTFILES_DIR/script/setup-homebrew"
